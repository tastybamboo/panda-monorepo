#!/usr/bin/env bash
# Bootstrap script for Panda monorepo
#
# This script initializes a new Panda development environment from scratch.
# Run this once when setting up a new machine or fresh clone.
#
# Usage:
#   curl -fsSL https://raw.githubusercontent.com/tastybamboo/claude-code-settings/main/init | bash
#
# Or if you already have this repository:
#   ./init

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
NC='\033[0m' # No Color

echo ""
echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘         Panda Monorepo Initialization                  â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Function to print step header
print_step() {
  echo -e "${BOLD}${BLUE}â–¶ $1${NC}"
}

# Function to print success
print_success() {
  echo -e "${GREEN}âœ“ $1${NC}"
}

# Function to print warning
print_warning() {
  echo -e "${YELLOW}âš  $1${NC}"
}

# Function to print error
print_error() {
  echo -e "${RED}âœ— $1${NC}"
}

# Function to print info
print_info() {
  echo -e "${BLUE}â„¹ $1${NC}"
}

# Detect if we're already in the repository or need to clone
if [ -f "$(pwd)/projects.json" ] && [ -f "$(pwd)/CLAUDE.md" ]; then
  REPO_DIR="$(pwd)"
  print_info "Running from existing repository: $REPO_DIR"
else
  REPO_DIR="$HOME/Projects/panda"

  print_step "Checking if Panda monorepo already exists..."

  if [ -d "$REPO_DIR" ]; then
    print_warning "Directory $REPO_DIR already exists"
    echo ""
    read -p "Do you want to reinitialize this directory? (y/N): " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      print_info "Exiting without changes"
      exit 0
    fi
  else
    print_step "Creating directory: $REPO_DIR"
    mkdir -p "$REPO_DIR"
    print_success "Directory created"
  fi

  print_step "Cloning claude-code-settings repository..."

  if [ -d "$REPO_DIR/.git" ]; then
    print_info "Git repository already exists, pulling latest changes..."
    cd "$REPO_DIR"
    git pull
  else
    git clone git@github.com:tastybamboo/claude-code-settings.git "$REPO_DIR"
    print_success "Repository cloned"
  fi
fi

cd "$REPO_DIR"
echo ""

# Check prerequisites
print_step "Checking prerequisites..."

MISSING_PREREQS=0

if ! command -v git &> /dev/null; then
  print_error "git is not installed"
  MISSING_PREREQS=1
fi

if ! command -v ruby &> /dev/null; then
  print_error "Ruby is not installed"
  MISSING_PREREQS=1
fi

if ! command -v bundle &> /dev/null; then
  print_error "Bundler is not installed (run: gem install bundler)"
  MISSING_PREREQS=1
fi

if ! command -v jq &> /dev/null; then
  print_error "jq is not installed (run: brew install jq)"
  MISSING_PREREQS=1
fi

if ! command -v gh &> /dev/null; then
  print_error "GitHub CLI (gh) is not installed (run: brew install gh)"
  MISSING_PREREQS=1
fi

if [ $MISSING_PREREQS -eq 1 ]; then
  echo ""
  print_error "Missing prerequisites. Please install the required tools and try again."
  exit 1
fi

print_success "All prerequisites satisfied"
echo ""

# Discover panda-* repositories
print_step "Discovering panda-* repositories in tastybamboo org..."
echo ""

# Check if gh is authenticated
if ! gh auth status &> /dev/null; then
  print_warning "GitHub CLI is not authenticated"
  echo ""
  print_info "Please authenticate with GitHub CLI:"
  echo "  gh auth login"
  echo ""
  exit 1
fi

# Fetch all repositories from tastybamboo org
print_info "Fetching repositories from tastybamboo organization..."
REPOS=$(gh repo list tastybamboo --limit 100 --json name,sshUrl,isPrivate 2>/dev/null)

if [ $? -ne 0 ]; then
  print_error "Failed to fetch repositories. Check your GitHub access."
  exit 1
fi

# Filter for panda-* repositories
PANDA_REPOS=$(echo "$REPOS" | jq -r '.[] | select(.name | startswith("panda-")) | {name: .name, url: .sshUrl, private: .isPrivate}' | jq -s '.')

if [ "$(echo "$PANDA_REPOS" | jq 'length')" -eq 0 ]; then
  print_warning "No panda-* repositories found in tastybamboo organization"
  echo ""
else
  REPO_COUNT=$(echo "$PANDA_REPOS" | jq 'length')
  print_success "Found $REPO_COUNT panda-* repositories"
  echo ""

  # Show discovered repositories
  echo "Discovered repositories:"
  echo "$PANDA_REPOS" | jq -r '.[] | "  â€¢ \(.name)\(.private | if . then " (private)" else "" end)"'
  echo ""

  # Clone discovered panda gem repositories
  print_step "Cloning panda gem repositories..."
  echo ""

  mkdir -p gems
  echo "$PANDA_REPOS" | jq -c '.[]' | while read -r repo; do
    name=$(echo "$repo" | jq -r '.name')
    url=$(echo "$repo" | jq -r '.url')
    is_private=$(echo "$repo" | jq -r '.private')

    target="gems/$name"

    if [ -d "$target" ]; then
      print_info "$name already exists, pulling latest..."
      (cd "$target" && git pull > /dev/null 2>&1 && echo "   âœ“ Updated" || echo "   âš  Failed to update")
    else
      echo "ğŸ“¦ Cloning $name..."
      if git clone "$url" "$target" > /dev/null 2>&1; then
        echo "   âœ“ Cloned successfully"
      else
        if [ "$is_private" = "true" ]; then
          echo "   âŠ³ Skipped (no access to private repo)"
        else
          echo "   âœ— Failed to clone"
        fi
      fi
    fi
  done

  echo ""
fi

# Clone automation repositories
print_step "Cloning automation repositories..."
echo ""

mkdir -p automation

declare -A AUTOMATION_REPOS=(
  ["automation/ci-tooling"]="git@github.com:tastybamboo/ci-tooling.git"
  ["automation/panda-assets-verify-action"]="git@github.com:tastybamboo/panda-assets-verify-action.git"
)

for name in "${!AUTOMATION_REPOS[@]}"; do
  url="${AUTOMATION_REPOS[$name]}"

  if [ -d "$name" ]; then
    print_info "$(basename $name) already exists, pulling latest..."
    (cd "$name" && git pull > /dev/null 2>&1 && echo "   âœ“ Updated" || echo "   âš  Failed to update")
  else
    echo "ğŸ“¦ Cloning $(basename $name)..."
    if git clone "$url" "$name" > /dev/null 2>&1; then
      echo "   âœ“ Cloned successfully"
    else
      echo "   âœ— Failed to clone"
    fi
  fi
done

echo ""

# Clone other repositories
print_step "Cloning additional repositories..."
echo ""

declare -A OTHER_REPOS=(
  ["generator"]="git@github.com:tastybamboo/generator.git"
)

for name in "${!OTHER_REPOS[@]}"; do
  url="${OTHER_REPOS[$name]}"

  if [ -d "$name" ]; then
    print_info "$name already exists, pulling latest..."
    (cd "$name" && git pull > /dev/null 2>&1 && echo "   âœ“ Updated" || echo "   âš  Failed to update")
  else
    echo "ğŸ“¦ Cloning $name..."
    if git clone "$url" "$name" > /dev/null 2>&1; then
      echo "   âœ“ Cloned successfully"
    else
      echo "   âœ— Failed to clone"
    fi
  fi
done

echo ""

# Install git hooks
print_step "Installing git hooks..."
echo ""

if [ -f "./bin/setup-hooks" ]; then
  ./bin/setup-hooks
  echo ""
else
  print_warning "bin/setup-hooks not found, skipping"
  echo ""
fi

echo ""
echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${GREEN}â•‘         Initialization Complete!                       â•‘${NC}"
echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
echo "Your Panda monorepo is ready at: ${BOLD}$REPO_DIR${NC}"
echo ""
echo "ğŸ’¡ Next steps:"
echo ""
echo "   ${BOLD}1. Add to your PATH${NC} (add to ~/.zshrc or ~/.bashrc):"
echo "      export PATH=\"$REPO_DIR/bin:\$PATH\""
echo ""
echo "   ${BOLD}2. Reload your shell:${NC}"
echo "      source ~/.zshrc"
echo ""
echo "   ${BOLD}3. Try the panda CLI:${NC}"
echo "      panda --help"
echo "      panda gems list"
echo "      panda css compile"
echo ""
echo "   ${BOLD}4. Start working on a gem:${NC}"
echo "      cd $REPO_DIR/gems/panda-core"
echo "      bundle install"
echo ""
